# 設計書レビュー：不足情報リスト

## 🔴 重要（実装に必須）

### 1. Manifest V3設定詳細
- **現状**: 「Manifest V3」と記載のみ
- **不足**: 
  - `manifest.json` の具体的な設定内容
  - Content Scriptの注入方法（`matches`, `js`, `run_at`）
  - 権限の詳細設定（`permissions`, `host_permissions`）
  - Action（Popup）の設定
  - Background Service Workerの設定
  - ショートカットキーの設定（`commands`）

### 2. メッセージパッシング仕様
- **現状**: 「Background Scriptへメッセージ送信」と記載のみ
- **不足**:
  - メッセージ形式（`chrome.runtime.sendMessage` のペイロード）
  - メッセージタイプ（`PROMPT_SENT`, `MANUAL_COUNT` 等）
  - エラーハンドリング（メッセージ送信失敗時の処理）
  - レスポンス形式

### 3. タイムスタンプ生成の詳細
- **現状**: 「YYYY-MM-DD HH:mm:ss形式」と記載のみ
- **不足**:
  - タイムゾーンの扱い（ローカル時間 / UTC）
  - フォーマット生成方法（`Date` オブジェクトからの変換ロジック）
  - 秒の精度（秒単位のみか、ミリ秒も含むか）

### 4. UUID生成方法
- **現状**: 「UUID v4」と記載のみ
- **不足**:
  - 生成ライブラリ（`crypto.randomUUID()` 等）
  - フォールバック処理（古いブラウザ対応）

### 5. デデュープロジックの実装詳細
- **現状**: 「2秒以内は1回に丸める」と記載のみ
- **不足**:
  - 実装方法（Background Scriptでの重複チェック）
  - デデュープキーの生成ロジック詳細
  - タブIDの取得方法（`chrome.tabs.getCurrent()` 等）
  - デデュープ用の一時ストレージ設計

### 6. CSVエクスポートの詳細仕様
- **現状**: 「送信イベント単位でCSV出力」と記載のみ
- **不足**:
  - CSVフォーマット（ヘッダー行、列の順序）
  - ファイル名の命名規則（`prompt-counter-YYYY-MM-DD.csv` 等）
  - エンコーディング（UTF-8 with BOM 等）
  - ダウンロード方法（`chrome.downloads` API または Blob URL）

### 7. ストレージ操作の詳細
- **現状**: 「`chrome.storage.local` への保存」と記載のみ
- **不足**:
  - 保存処理のエラーハンドリング
  - 容量制限への対応（10,000件超の場合）
  - クリーンアップロジックの実装詳細（90日以上前のデータ削除）
  - データ読み込み時のエラーハンドリング

### 8. ショートカットキーの設定
- **現状**: 「ショートカット（例：Ctrl/Cmd + Shift + 1）」と記載のみ
- **不足**:
  - `manifest.json` での `commands` 設定
  - キーコンビネーションの詳細
  - プラットフォーム別の違い（Windows/Mac/Linux）

---

## 🟡 推奨（実装を円滑にするため）

### 9. ファイル構造
- **不足**:
  - プロジェクトのディレクトリ構造
  - 各ファイルの役割
  - エントリーポイント

### 10. 依存関係
- **現状**: 「Chart.js」「Vite / Webpack」と記載のみ
- **不足**:
  - `package.json` の想定内容
  - 各ライブラリのバージョン
  - ビルドツールの選択基準（Vite vs Webpack）

### 11. エラーハンドリング全般
- **現状**: 「保存に失敗した場合：次回起動時にリトライは不要」と記載のみ
- **不足**:
  - 各処理でのエラーハンドリング方針
  - ユーザーへのエラー通知方法
  - ログ出力の有無

### 12. データ検証
- **不足**:
  - 保存前のデータ検証ロジック
  - 不正データの扱い
  - データ整合性チェック

### 13. パフォーマンス考慮
- **不足**:
  - 大量データ（10,000件）での表示パフォーマンス
  - チャート描画の最適化
  - ストレージ読み込みの最適化

### 14. バージョン管理
- **不足**:
  - バージョン番号の管理方法
  - データマイグレーション（将来のスキーマ変更時）

### 15. 開発環境・ビルド手順
- **不足**:
  - 開発環境のセットアップ手順
  - ビルドコマンド
  - ローカルでのテスト方法
  - Chrome拡張機能のロード方法

### 16. デプロイ・リリース手順
- **不足**:
  - Chrome Web Store申請の詳細手順
  - アイコン・スクリーンショットの要件
  - ストア説明文の要件

---

## 🟢 任意（品質向上のため）

### 17. ログ・デバッグ
- **不足**:
  - デバッグモードの有無
  - ログ出力のレベル設定
  - 開発者ツールでの確認方法

### 18. アクセシビリティ
- **不足**:
  - キーボード操作対応
  - スクリーンリーダー対応
  - 色のコントラスト比

### 19. 国際化（i18n）
- **不足**:
  - 多言語対応の有無
  - 日付フォーマットの地域差対応

### 20. テスト環境
- **不足**:
  - 自動テストの有無
  - テストフレームワークの選択
  - CI/CDの有無

---

## 📝 整合性チェックで発見した問題

### DESIGN.md
- **54行目**: データ項目に `day, hour` が記載されているが、これは削除済みのはず（170行目で「保存せず」と明記）
- **18行目**: 「CSVエクスポート（日次×ツール）」→「送信イベント単位」に修正が必要
- **54行目**: データ項目が `ts, tool, source, day, hour` となっているが、正しくは `id, ts, tool, source`
- **56-58行目**: 「集計」セクションが残っているが、これは「表示時の動的集計」に変更済みのはず
- **67行目**: 「日次集計をCSV出力」→「送信イベント単位でCSV出力」に修正が必要
- **240行目**: デデュープが「3秒以内」と記載されているが、SPEC.mdでは「2秒以内」

### SPEC.md
- **38行目**: デデュープキーの例で `ts_ms` を使用しているが、実際のデータモデルでは `ts` は文字列形式

---

## ✅ 実施済みアクション

1. ✅ **DESIGN.mdの整合性修正**（問題点を修正）
2. ✅ **実装仕様の詳細化**（DESIGN.mdに追加）
   - Manifest V3設定詳細
   - メッセージパッシング仕様
   - タイムスタンプ生成の詳細
   - UUID生成方法
   - デデュープロジックの実装詳細
   - CSVエクスポートの詳細仕様
   - ストレージ操作の詳細
   - ショートカットキーの設定
   - ファイル構造
   - 依存関係
   - エラーハンドリング
   - データ検証
   - パフォーマンス考慮
   - バージョン管理
   - 開発環境・ビルド手順
3. ✅ **SPEC.mdの詳細化**（デデュープロジック、タイムスタンプ生成、エラーハンドリング）

## 📋 残タスク（任意）

- デプロイ・リリース手順の詳細化（Chrome Web Store申請手順等）

